<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>GPO Search Tool</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#1a1a2e;color:#e0e0e0;min-height:100vh}
.header{background:#16213e;border-bottom:1px solid #2a3a5c;padding:16px 24px;position:sticky;top:0;z-index:10}
.header h1{font-size:20px;color:#4fc3f7;margin-bottom:12px;display:flex;align-items:center;gap:12px}
.header h1 small{font-size:12px;color:#a0a8c0;font-weight:400}
.search-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.search-wrap{flex:1;min-width:250px;position:relative}
.search-wrap input{width:100%;padding:10px 36px 10px 14px;background:#1a1a2e;border:1px solid #2a3a5c;border-radius:8px;color:#e0e0e0;font-size:15px;outline:none}
.search-wrap input:focus{border-color:#4fc3f7}
.search-wrap .clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#555;font-size:18px;cursor:pointer;padding:0 4px;display:none}
.search-wrap .clear:hover{color:#ef5350}
.search-wrap input:not(:placeholder-shown)~.clear{display:block}
button{padding:8px 16px;background:#0f3460;border:1px solid #2a3a5c;border-radius:8px;color:#e0e0e0;cursor:pointer;font-size:13px;white-space:nowrap}
button:hover:not(:disabled){border-color:#4fc3f7;color:#4fc3f7}
button:disabled{opacity:.35;cursor:default}
.btn-accent{background:#4fc3f7;color:#1a1a2e;border-color:#4fc3f7;font-weight:600}
.btn-accent:hover:not(:disabled){background:#81d4fa;color:#1a1a2e}
.toggle{padding:8px 12px}
.toggle.on{background:#0f3460;border-color:#4fc3f7;color:#4fc3f7}
.status-bar{padding:8px 24px;background:#16213e;border-bottom:1px solid #2a3a5c;font-size:13px;color:#a0a8c0;display:flex;justify-content:space-between;align-items:center}
.filters{padding:6px 24px;background:#141e33;border-bottom:1px solid #2a3a5c;display:none;flex-wrap:wrap;gap:6px;align-items:center}
.chip{padding:3px 10px;background:#0f3460;border:1px solid #2a3a5c;border-radius:14px;color:#a0a8c0;font-size:11px;cursor:pointer;white-space:nowrap;transition:all .15s}
.chip:hover{border-color:#4fc3f7;color:#4fc3f7}
.chip.on{background:#1a3a5c;border-color:#4fc3f7;color:#4fc3f7}
.chip .cnt{opacity:.5;margin-left:3px;font-size:10px}
.chip-clear{color:#ef5350;border-color:#3a2020}
.chip-clear:hover{border-color:#ef5350;color:#ef5350}
#results{padding:12px 24px}
.card{background:#1e2746;border:1px solid #2a3a5c;border-radius:8px;padding:12px 16px;margin-bottom:8px;cursor:pointer;transition:border-color .15s}
.card:hover{border-color:#4fc3f7}
.card-name{font-size:14px;font-weight:600;margin-bottom:4px}
.card-meta{font-size:12px;color:#a0a8c0;margin-bottom:6px}
.card-preview{font-size:12px;color:#666;line-height:1.5;max-height:36px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card-match{font-size:12px;color:#ccc;line-height:1.6;background:#141a2e;border-radius:4px;padding:6px 10px;max-height:160px;overflow-y:auto;white-space:pre-wrap;word-break:break-word}
.card-section{font-size:10px;color:#4fc3f7;opacity:.65;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
mark{background:rgba(79,195,247,.3);color:#ffee58;border-radius:2px;padding:0 1px}
.welcome{text-align:center;padding:80px 24px;color:#a0a8c0}
.welcome h2{color:#4fc3f7;margin-bottom:12px;font-size:24px}
.welcome p{margin-bottom:8px;max-width:500px;margin-left:auto;margin-right:auto}
.codebox{text-align:left;background:#0d1117;border:1px solid #2a3a5c;border-radius:8px;padding:16px 20px;margin:20px auto 0;max-width:720px;position:relative;font-family:'Cascadia Code','Fira Code','Consolas',monospace;font-size:13px;line-height:1.7;color:#c9d1d9;overflow-x:auto;white-space:pre}
.codebox-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #2a3a5c}
.codebox-label{font-size:12px;color:#4fc3f7;font-family:'Segoe UI',system-ui,sans-serif;font-weight:600;letter-spacing:.5px;text-transform:uppercase}
.codebox-copy{background:#1a2332;border:1px solid #2a3a5c;border-radius:5px;color:#a0a8c0;font-size:11px;cursor:pointer;padding:4px 10px;font-family:'Segoe UI',system-ui,sans-serif}
.codebox-copy:hover{border-color:#4fc3f7;color:#4fc3f7}
.codebox .comment{color:#6a737d}
.codebox .cmd{color:#79c0ff}
.codebox .param{color:#d2a8ff}
.codebox .str{color:#a5d6ff}
.codebox .var{color:#ffa657}
.progress{width:100%;height:4px;background:#2a3a5c;border-radius:2px;margin-top:8px;overflow:hidden;display:none}
.progress .fill{height:100%;background:#4fc3f7;border-radius:2px;transition:width .2s;width:0}
.pagination{display:flex;justify-content:center;gap:6px;padding:16px}
.pagination button{padding:6px 12px}
.pagination button.active{background:#0f3460;border-color:#4fc3f7;color:#4fc3f7}
#detailOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100}
#detailPanel{position:fixed;top:0;right:0;bottom:0;width:55%;min-width:400px;max-width:800px;background:#16213e;border-left:1px solid #2a3a5c;overflow-y:auto;padding:24px;z-index:101}
#detailPanel .close{position:absolute;top:12px;right:16px;background:none;border:none;color:#a0a8c0;font-size:24px;cursor:pointer}
#detailPanel .close:hover{color:#fff}
#detailPanel h2{color:#4fc3f7;font-size:18px;margin-bottom:16px;padding-right:40px;word-break:break-word}
#detailPanel iframe{width:100%;height:calc(100% - 60px);border:none;border-radius:6px;background:#fff}
@media(max-width:700px){#detailPanel{width:100%;min-width:0}}
.footer{position:fixed;bottom:0;left:0;right:0;padding:6px 24px;background:#111627;border-top:1px solid #1e2a45;font-size:11px;color:#555;display:flex;justify-content:space-between;z-index:9}
.footer a{color:#555;text-decoration:none}
.footer a:hover{color:#4fc3f7}
</style>
</head>
<body>

<div class="header">
    <h1>GPO Search Tool <small id="fileCount"></small></h1>
    <div class="search-row">
        <button class="btn-accent" id="btnLoad">Map laden</button>
        <div class="search-wrap">
            <input type="text" id="q" placeholder="Zoek op keywords... (bijv. BitLocker, &quot;edge blocklist&quot;, HKEY_LOCAL)" disabled>
            <button class="clear" id="btnClear" type="button">&times;</button>
        </div>
        <button class="toggle" id="btnRegex" title="Regex aan/uit" disabled>.*</button>
        <button class="toggle" id="btnCase" title="Hoofdlettergevoelig" disabled>Aa</button>
        <button id="btnSearch" disabled>Zoeken</button>
    </div>
    <div class="progress" id="progress"><div class="fill" id="progressFill"></div></div>
    <input type="file" id="folderPicker" webkitdirectory multiple style="display:none">
</div>

<div class="status-bar">
    <span id="statusText">Klik "Map laden" en selecteer de GPO map</span>
    <span id="statusRight"></span>
</div>

<div id="filters" class="filters"></div>

<div id="results">
    <div class="welcome" id="welcome">
        <h2>GPO Search Tool</h2>
        <p>Doorzoek al je GPMC HTML-exports op keywords, policy namen, registry paden en meer.</p>
        <p>1. Klik <strong>"Map laden"</strong> en selecteer de <strong>GPO</strong> map</p>
        <p>2. Wacht tot alle bestanden ingelezen zijn</p>
        <p>3. Begin te typen om te zoeken</p>
        <div class="codebox">
            <div class="codebox-header">
                <span class="codebox-label">PowerShell — GPO's exporteren als HTML</span>
                <button class="codebox-copy" onclick="copyCode(this)" type="button">Kopieer</button>
            </div><span class="cmd">mkdir</span> <span class="str">C:\GPO-Export</span> <span class="param">-Force</span>; <span class="cmd">Get-GPO</span> <span class="param">-All</span> | <span class="cmd">%</span>{<span class="cmd">Get-GPOReport</span> <span class="param">-Guid</span> <span class="var">$_</span>.Id <span class="param">-ReportType</span> Html <span class="param">-Path</span> <span class="str">"C:\GPO-Export\$(<span class="var">$_</span>.DisplayName <span class="param">-replace</span> <span class="str">'[\\/:*?"&lt;&gt;|]'</span>,<span class="str">'_'</span>).html"</span>}</div>
    </div>
</div>

<div class="footer">
    <span>GPO Search Tool v1.1.3</span>
    <a href="https://github.com/ThaFridge/GPOSearch" target="_blank">GitHub</a>
</div>

<div id="detailOverlay" onclick="closeDetail()"></div>
<div id="detailPanel" style="display:none">
    <button class="close" onclick="closeDetail()">&times;</button>
    <h2 id="detailTitle"></h2>
    <iframe id="detailFrame"></iframe>
</div>

<script>
// --- Tag detection rules ---
const TAG_RULES = [
    [/BitLocker/i, 'BitLocker'],
    [/Google\s*Chrome/i, 'Chrome'],
    [/Microsoft\s*Edge/i, 'Edge'],
    [/Firewall/i, 'Firewall'],
    [/OneDrive/i, 'OneDrive'],
    [/Internet\s*Explorer/i, 'IE'],
    [/Windows\s*Update/i, 'Windows Update'],
    [/Remote\s*Desktop/i, 'Remote Desktop'],
    [/Removable\s*Storage/i, 'USB'],
    [/Screen\s*Saver/i, 'Screensaver'],
    [/\bZoom\b/i, 'Zoom'],
    [/PowerShell/i, 'PowerShell'],
    [/\bLAPS\b/, 'LAPS'],
    [/\bVPN\b|AlwaysOnVPN/i, 'VPN'],
    [/\bPrinter/i, 'Printers'],
    [/\bRegistry\b/i, 'Registry'],
    [/AppLocker/i, 'AppLocker'],
    [/Defender/i, 'Defender'],
    [/Credential\s*Guard/i, 'Credential Guard'],
    [/Windows\s*Ink/i, 'Windows Ink'],
    [/\bWi-?Fi\b|Wireless/i, 'Wi-Fi'],
];

function matchTags(str, tags) {
    if (!str) return;
    for (const [re, tag] of TAG_RULES) {
        if (re.test(str)) tags.add(tag);
    }
}

function cleanDesc(v) {
    return (v || '').replace(/<br\s*\/?>/gi, ' ').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
}

// --- GPO content extraction with section tracking ---
function extractGpoContent(html) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const tags = new Set();
    const segments = [];

    function add(s, path) {
        s = (s || '').replace(/\s+/g, ' ').trim();
        if (s) segments.push({ str: s, path: path || '' });
    }

    // GPO header
    const gn = doc.querySelector('.gponame');
    if (gn) add(gn.textContent, 'General');
    const dt = doc.getElementById('dtstamp');
    if (dt) add(dt.textContent, 'General');

    // Walk full body — GPO content lives as siblings of .gposummary, not inside it
    const root = doc.body;
    if (root) {
        const crumbs = [];
        const allDivs = root.getElementsByTagName('div');
        for (const div of allDivs) {
            const cls = div.className || '';
            const classes = cls.split(/\s+/);

            // Section header (he0..he5 variants, NOT ending with 'i')
            const hdrCls = classes.find(c => /^he\d/.test(c) && !/i$/.test(c));
            if (hdrCls) {
                const lvl = parseInt(hdrCls.charAt(2));
                const titleEl = div.querySelector('.sectionTitle');
                if (titleEl) {
                    const title = titleEl.textContent.trim();
                    crumbs.length = lvl;
                    crumbs[lvl] = title;
                    matchTags(title, tags);
                }
                continue;
            }

            // Content block (he2i, he4i, he5i)
            if (classes.some(c => /^he\di$/.test(c))) {
                const path = crumbs.filter(Boolean).join(' > ');
                add(div.textContent, path);
            }
        }

        // gpmc_ attributes (extra searchable content not in visible text)
        root.querySelectorAll('span.explainlink').forEach(el => {
            const sn = el.getAttribute('gpmc_settingname') || '';
            const sp = el.getAttribute('gpmc_settingpath') || '';
            const desc = el.getAttribute('gpmc_settingdescription') || '';
            const sup = el.getAttribute('gpmc_supported') || '';
            if (sn) add(sn, sp || 'Settings');
            if (sp) { add(sp, sp); matchTags(sp, tags); }
            if (desc) add(cleanDesc(desc), sp || 'Settings');
            if (sup) add(sup, sp || 'Settings');
        });
    }

    // Fallback for non-GPMC HTML (no he* structure found)
    if (!segments.length && root) {
        root.querySelectorAll('script, style').forEach(el => el.remove());
        add(root.textContent, '');
    }

    // Build flat text with section index
    let text = '';
    const sections = [];
    for (const s of segments) {
        if (!s.str) continue;
        const start = text.length;
        text += s.str + ' ';
        sections.push({ start, end: start + s.str.length, path: s.path });
    }
    text = text.trimEnd();

    return { text, sections, tags: [...tags] };
}

function findSection(sections, idx) {
    for (const s of sections) {
        if (idx >= s.start && idx < s.end) return s.path;
    }
    return '';
}

// --- App state ---
const PAGE_SIZE = 50;
let files = [];
let results = [];
let page = 0;
let isSearching = false;
let allTags = {};
let activeFilters = new Set();

const $ = id => document.getElementById(id);
const q = $('q');
const statusText = $('statusText');
const statusRight = $('statusRight');
const resultsDiv = $('results');

// --- Filter system ---
function getFilteredFiles() {
    if (!activeFilters.size) return files;
    return files.filter(f => f.tags.some(t => activeFilters.has(t)));
}

function buildFilters() {
    allTags = {};
    for (const f of files) {
        for (const t of f.tags) {
            allTags[t] = (allTags[t] || 0) + 1;
        }
    }
    renderFilters();
}

function renderFilters() {
    const container = $('filters');
    const sorted = Object.entries(allTags)
        .filter(([, c]) => c >= 2)
        .sort((a, b) => b[1] - a[1]);

    if (!sorted.length) { container.style.display = 'none'; return; }

    let html = '';
    if (activeFilters.size) {
        html += '<span class="chip chip-clear" onclick="clearFilters()">Wis filters</span>';
    }
    for (const [tag, count] of sorted) {
        const on = activeFilters.has(tag) ? ' on' : '';
        html += `<span class="chip${on}" onclick="toggleFilter('${escAttr(tag)}')">${esc(tag)}<span class="cnt">${count}</span></span>`;
    }
    container.innerHTML = html;
    container.style.display = 'flex';
}

function toggleFilter(tag) {
    if (activeFilters.has(tag)) activeFilters.delete(tag);
    else activeFilters.add(tag);
    renderFilters();
    if (q.value.trim()) doSearch();
    else showAll();
}

function clearFilters() {
    activeFilters.clear();
    renderFilters();
    if (q.value.trim()) doSearch();
    else showAll();
}

// --- Controls ---
$('btnRegex').onclick = function(){ this.classList.toggle('on'); doSearch(); };
$('btnCase').onclick = function(){ this.classList.toggle('on'); doSearch(); };
$('btnLoad').onclick = () => $('folderPicker').click();

$('btnClear').onclick = function() {
    q.value = '';
    this.style.display = 'none';
    showAll();
    q.focus();
};

// --- File loading ---
$('folderPicker').onchange = async function() {
    const picked = Array.from(this.files).filter(f =>
        f.name.endsWith('.html') && !f.name.startsWith('._')
    );
    if (!picked.length) {
        statusText.textContent = 'Geen HTML bestanden gevonden in deze map.';
        return;
    }

    files = [];
    activeFilters.clear();
    $('progress').style.display = 'block';
    $('btnLoad').disabled = true;
    q.disabled = true;
    statusText.textContent = `Inlezen: 0 / ${picked.length}`;
    resultsDiv.innerHTML = '';
    $('filters').style.display = 'none';

    for (let i = 0; i < picked.length; i++) {
        const f = picked[i];
        try {
            const buf = await f.arrayBuffer();
            const bytes = new Uint8Array(buf);
            let text;
            if (bytes[0] === 0xFF && bytes[1] === 0xFE) {
                text = new TextDecoder('utf-16le').decode(buf);
            } else if (bytes[0] === 0xFE && bytes[1] === 0xFF) {
                text = new TextDecoder('utf-16be').decode(buf);
            } else {
                text = new TextDecoder('utf-16le').decode(buf);
                if (text.indexOf('<html') === -1 && text.indexOf('<HTML') === -1) {
                    text = new TextDecoder('utf-8').decode(buf);
                }
            }

            const result = extractGpoContent(text);
            files.push({ name: f.name, text: result.text, sections: result.sections, tags: result.tags, blob: f });
        } catch(e) {}

        if ((i+1) % 50 === 0 || i === picked.length - 1) {
            $('progressFill').style.width = Math.round(((i+1) / picked.length) * 100) + '%';
            statusText.textContent = `Inlezen: ${i+1} / ${picked.length}`;
            await new Promise(r => setTimeout(r, 0));
        }
    }

    $('progress').style.display = 'none';
    $('btnLoad').disabled = false;
    q.disabled = false;
    $('btnSearch').disabled = false;
    $('btnRegex').disabled = false;
    $('btnCase').disabled = false;
    $('fileCount').textContent = `${files.length} bestanden geladen`;
    q.focus();

    buildFilters();
    showAll();
};

// --- Browse & Search ---
function showAll() {
    isSearching = false;
    const src = getFilteredFiles();
    results = src.map(f => ({ name: f.name, matchCount: 0, snippets: [], blob: f.blob, preview: f.text.slice(0, 150) }));
    results.sort((a, b) => a.name.localeCompare(b.name));
    const filterNote = activeFilters.size ? ' (gefilterd)' : '';
    statusText.textContent = `${results.length} GPO bestanden${filterNote}`;
    statusRight.textContent = '';
    page = 0;
    renderPage();
}

// Parse query: supports "exact phrases" and loose words (AND logic)
function parseQuery(input) {
    const terms = [];
    const re = /"([^"]+)"|(\S+)/g;
    let m;
    while (m = re.exec(input)) {
        terms.push(m[1] || m[2]);
    }
    return terms.filter(Boolean);
}

function buildSearchRegex(terms, caseSens) {
    const escaped = terms.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    return new RegExp(escaped.join('|'), caseSens ? 'g' : 'gi');
}

function doSearch() {
    const query = q.value.trim();
    const src = getFilteredFiles();
    if (!src.length) return;

    if (!query) { showAll(); return; }

    isSearching = true;
    const useRegex = $('btnRegex').classList.contains('on');
    const caseSens = $('btnCase').classList.contains('on');
    const t0 = performance.now();

    let re, andCheck;
    try {
        if (useRegex) {
            re = new RegExp(query, caseSens ? 'g' : 'gi');
        } else {
            const terms = parseQuery(query);
            if (!terms.length) { showAll(); return; }
            re = buildSearchRegex(terms, caseSens);
            andCheck = terms.map(t => caseSens ? t : t.toLowerCase());
        }
    } catch(e) {
        resultsDiv.innerHTML = `<div class="welcome"><p style="color:#ef5350">Ongeldige regex: ${esc(e.message)}</p></div>`;
        return;
    }

    results = [];
    for (const f of src) {
        if (andCheck) {
            const s = caseSens ? f.text : f.text.toLowerCase();
            if (!andCheck.every(t => s.includes(t))) continue;
        }

        re.lastIndex = 0;
        const matches = [];
        let m;
        while ((m = re.exec(f.text)) !== null && matches.length < 10) {
            matches.push({ idx: m.index, len: m[0].length, val: m[0] });
            if (!re.global) break;
        }

        if (matches.length > 0) {
            const snippets = [];
            for (const mt of matches.slice(0, 5)) {
                const start = Math.max(0, mt.idx - 80);
                const end = Math.min(f.text.length, mt.idx + mt.len + 80);
                let snip = f.text.slice(start, end);
                if (start > 0) snip = '...' + snip;
                if (end < f.text.length) snip += '...';
                const section = findSection(f.sections, mt.idx);
                snippets.push({ text: snip, section });
            }
            results.push({ name: f.name, matchCount: matches.length, snippets, blob: f.blob });
        }
    }

    results.sort((a, b) => b.matchCount - a.matchCount);

    const elapsed = (performance.now() - t0).toFixed(1);
    const filterNote = activeFilters.size ? ' (gefilterd)' : '';
    statusText.textContent = `${results.length} resultaten van ${src.length} bestanden${filterNote}`;
    statusRight.textContent = elapsed + 'ms';

    page = 0;
    renderPage();
}

// --- Rendering ---
function renderPage() {
    const query = q.value.trim();
    const useRegex = $('btnRegex').classList.contains('on');
    const caseSens = $('btnCase').classList.contains('on');
    const start = page * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, results.length);
    const slice = results.slice(start, end);

    let hlRe = null;
    if (query && isSearching) {
        try {
            if (useRegex) {
                hlRe = new RegExp('(' + query + ')', caseSens ? 'g' : 'gi');
            } else {
                const terms = parseQuery(query);
                if (terms.length) {
                    const base = buildSearchRegex(terms, caseSens);
                    hlRe = new RegExp('(' + base.source + ')', base.flags);
                }
            }
        } catch(e) { hlRe = null; }
    }

    const total = results.length;
    const rangeText = total > 0 ? `${start + 1}-${end} van ${total}` : '0';

    let html = '';
    for (const r of slice) {
        if (isSearching) {
            const snippetHtml = r.snippets.map(s => {
                let h = esc(s.text);
                if (hlRe) h = h.replace(hlRe, '<mark>$1</mark>');
                const sec = s.section ? `<div class="card-section">${esc(s.section)}</div>` : '';
                return sec + h;
            }).join('\n');

            html += `<div class="card" onclick="openDetail('${escAttr(r.name)}')">
                <div class="card-name">${hlRe ? esc(r.name).replace(hlRe, '<mark>$1</mark>') : esc(r.name)}</div>
                <div class="card-meta">${r.matchCount} match${r.matchCount !== 1 ? 'es' : ''}</div>
                <div class="card-match">${snippetHtml}</div>
            </div>`;
        } else {
            html += `<div class="card" onclick="openDetail('${escAttr(r.name)}')">
                <div class="card-name">${esc(r.name)}</div>
                <div class="card-preview">${esc(r.preview || '')}</div>
            </div>`;
        }
    }

    // Pagination
    const totalPages = Math.ceil(total / PAGE_SIZE);
    if (totalPages > 1) {
        html += '<div class="pagination">';
        html += `<button ${page===0?'disabled':''} onclick="goPage(${page-1})">&#9664;</button>`;
        const maxBtns = 9;
        let s = Math.max(0, page - Math.floor(maxBtns/2));
        let e = Math.min(totalPages, s + maxBtns);
        if (e - s < maxBtns) s = Math.max(0, e - maxBtns);
        for (let i = s; i < e; i++) html += `<button class="${i===page?'active':''}" onclick="goPage(${i})">${i+1}</button>`;
        html += `<button ${page>=totalPages-1?'disabled':''} onclick="goPage(${page+1})">&#9654;</button>`;
        html += '</div>';
    }

    if (!slice.length) {
        html = '<div class="welcome"><p>Geen resultaten gevonden.</p></div>';
    }

    statusRight.textContent = isSearching ? statusRight.textContent : rangeText;
    if (!isSearching) statusText.textContent = `${total} GPO bestanden` + (activeFilters.size ? ' (gefilterd)' : '');
    else statusRight.textContent += `  |  ${rangeText}`;

    resultsDiv.innerHTML = html;
    resultsDiv.scrollTop = 0;
}

function goPage(p) { page = p; renderPage(); }

// --- Utilities ---
function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escAttr(s) {
    return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');
}

// --- Detail panel ---
function highlightInFrame(fdoc, query, useRegex, caseSens) {
    let re;
    try {
        const flags = caseSens ? 'g' : 'gi';
        if (useRegex) {
            re = new RegExp('(' + query + ')', flags);
        } else {
            const terms = parseQuery(query);
            if (!terms.length) return;
            re = buildSearchRegex(terms, caseSens);
            re = new RegExp('(' + re.source + ')', re.flags);
        }
    } catch(e) { return; }

    const walker = fdoc.createTreeWalker(fdoc.body, NodeFilter.SHOW_TEXT, null);
    const nodes = [];
    let n;
    while (n = walker.nextNode()) {
        if (n.parentNode.tagName === 'SCRIPT' || n.parentNode.tagName === 'STYLE') continue;
        re.lastIndex = 0;
        if (re.test(n.textContent)) nodes.push(n);
    }

    for (const textNode of nodes) {
        const frag = fdoc.createDocumentFragment();
        let txt = textNode.textContent, last = 0;
        re.lastIndex = 0;
        let m;
        while (m = re.exec(txt)) {
            if (m.index > last) frag.appendChild(fdoc.createTextNode(txt.slice(last, m.index)));
            const mark = fdoc.createElement('mark');
            mark.className = 'gpo-search-hl';
            mark.style.cssText = 'background:#ffe082;color:#000;padding:1px 2px;border-radius:2px';
            mark.textContent = m[0];
            frag.appendChild(mark);
            last = m.index + m[0].length;
        }
        if (last < txt.length) frag.appendChild(fdoc.createTextNode(txt.slice(last)));
        textNode.parentNode.replaceChild(frag, textNode);
    }
}

function openDetail(name) {
    const f = files.find(x => x.name === name);
    if (!f) return;
    $('detailTitle').textContent = name;
    const url = URL.createObjectURL(f.blob);
    const frame = $('detailFrame');
    frame.onload = function() {
        if (!isSearching || !q.value.trim()) return;
        try {
            const fdoc = frame.contentDocument;
            const fwin = frame.contentWindow;
            // Expand all sections using GPO's built-in functions
            if (fwin.IsSectionHeader && fwin.ShowSection) {
                const els = fdoc.body.getElementsByTagName('*');
                for (let i = 0; i < els.length; i++) {
                    if (fwin.IsSectionHeader(els[i])) fwin.ShowSection(els[i]);
                }
            }
            // Highlight search terms
            const query = q.value.trim();
            const useRegex = $('btnRegex').classList.contains('on');
            const caseSens = $('btnCase').classList.contains('on');
            highlightInFrame(fdoc, query, useRegex, caseSens);
            // Scroll to first match
            const first = fdoc.querySelector('.gpo-search-hl');
            if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } catch(e) {}
    };
    frame.src = url;
    $('detailPanel').style.display = 'block';
    $('detailOverlay').style.display = 'block';
}

function closeDetail() {
    $('detailPanel').style.display = 'none';
    $('detailOverlay').style.display = 'none';
    const frame = $('detailFrame');
    URL.revokeObjectURL(frame.src);
    frame.src = '';
}

function copyCode(btn) {
    const box = btn.closest('.codebox');
    const text = box.textContent.replace(/^PowerShell — GPO's exporteren als HTML\s*Kopieer\s*/, '').trim();
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Gekopieerd!';
        setTimeout(() => btn.textContent = 'Kopieer', 2000);
    });
}

// --- Live search ---
let debounce;
q.addEventListener('input', () => {
    clearTimeout(debounce);
    debounce = setTimeout(doSearch, 300);
});
q.addEventListener('keydown', e => { if (e.key === 'Enter') { clearTimeout(debounce); doSearch(); } });
$('btnSearch').onclick = doSearch;
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeDetail();
    if (e.key === '/' && document.activeElement !== q) { e.preventDefault(); q.focus(); }
});
</script>
</body>
</html>
